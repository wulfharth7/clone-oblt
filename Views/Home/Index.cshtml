@{
    ViewData["Title"] = "Home Page";
}

<h2>@ViewData["Title"]</h2>

<!-- Display session creation status -->
<div id="session-status"></div>

<!-- Display bus locations -->
<h3>Bus Locations:</h3>
<div id="bus-locations"></div>

<!-- Display journeys -->
<h3>Journeys:</h3>
<div id="journeys"></div>

<script>
    window.onload = function () {
        // First, create the session
        fetch('/api/Session/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                console.log("Response Status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Session Creation Data:", data);

                if (data.status === "Success" && data.data) {
                    // Display session info
                    document.getElementById('session-status').innerHTML =
                        `Session created successfully!<br>Session ID: ${data.data["session-id"]}<br>Device ID: ${data.data["device-id"]}`;
                    const payload = {

                    };
                    // Fetch bus locations
                    fetch('/api/buslocation/getbuslocations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.data) {
                                const busLocationsContainer = document.getElementById('bus-locations');
                                busLocationsContainer.innerHTML = '';

                                data.data.forEach(location => {
                                    const longName = location['name'];
                                    console.log(longName);
                                    const busLocationDiv = document.createElement('div');
                                    busLocationDiv.textContent = longName || "No name available";
                                    busLocationsContainer.appendChild(busLocationDiv);
                                });
                            } else {
                                console.error('No bus locations found');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching bus locations:', error);
                        });

                    fetch('/api/journeys/getjourneys', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.data) {
                                const journeysContainer = document.getElementById('journeys');
                                journeysContainer.innerHTML = '';

                                data.data.forEach(journey => {
                                    const journeyDiv = document.createElement('div');
                                    journeyDiv.textContent = `Journey from ${journey.OriginId} to ${journey.DestinationId}, Departure: ${journey.DepartureDate}`;
                                    journeysContainer.appendChild(journeyDiv);
                                });
                            } else {
                                console.error('No journeys found');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching journeys:', error);
                        });
                        
                } else {
                    document.getElementById('session-status').innerHTML = 'Failed to create session.';
                }
            })
            .catch(error => {
                console.error("Error occurred while creating session:", error);
                document.getElementById('session-status').innerHTML =
                    `Error occurred: ${error.message}`;
            });
    };
</script>
